{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- اطلاعات کاربر -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">اطلاعات تحویل گیرنده</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>نام و نام خانوادگی:</strong> {{ user.first_name }} {{ user.last_name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>شماره تماس:</strong> {{ user.phone }}</p>
                        </div>
                        <div class="col-12">
                            <p><strong>آدرس:</strong> {{ user.address }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- سبد خرید -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">سبد خرید شما</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>محصول</th>
                                    <th>تعداد</th>
                                    <th>قیمت واحد</th>
                                    <th>جمع</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>${{ item.price }}</td>
                                    <td>${{ item.total }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-group-divider">
                                <tr>
                                    <th colspan="3" class="text-end">مجموع کل:</th>
                                    <th>${{ total_amount }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- انتخاب روش پرداخت -->
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">انتخاب روش پرداخت</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% for currency in currencies %}
                        <button type="button" class="btn btn-outline-primary currency-btn" 
                                data-currency="{{ currency.code }}" 
                                data-address="{{ currency.address }}"
                                data-rate="{{ currency.rate }}">
                            <i class="{{ currency.icon }} me-2"></i>
                            پرداخت با {{ currency.name }}
                        </button>
                        {% endfor %}
                    </div>

                    <!-- نمایش اطلاعات پرداخت -->
                    <div id="payment-details" class="mt-4 d-none">
                        <div class="alert alert-info">
                            <h6>مبلغ قابل پرداخت:</h6>
                            <p id="payment-amount" class="h4 text-center"></p>
                        </div>
                        
                        <div class="text-center mb-3">
                            <img id="qr-code" src="" alt="QR Code" class="img-fluid" style="max-width: 200px;">
                        </div>
                        
                        <div class="input-group mb-3">
                            <input type="text" id="crypto-address" class="form-control" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyAddress()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        
                        <div class="d-grid">
                            <button class="btn btn-success" onclick="confirmPayment()">
                                تایید پرداخت
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal برای تایید پرداخت -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تایید پرداخت</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>آیا از پرداخت مبلغ <span id="modal-amount"></span> اطمینان دارید؟</p>
                <p>لطفا پس از انجام پرداخت، رسید آن را保存 کنید.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-primary" onclick="finalizePayment()">تایید پرداخت</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// آدرس‌های ثابت برای هر ارز
const cryptoAddresses = {
    'TRX': 'TW88rRvvvoo3dRpippmQJUNmowdmgaCjhE',
    'USDT': 'TW88rRvvvoo3dRpippmQJUNmowdmgaCjhE',
    'BTC': 'bc1qwc2lqwjxwc29tnxn6p2kstsrqcc0ems5957r5m',
    'ETH': '0xaF99374Dd015dA244cdA1F1Fc2183b423a17A10D',
    'BNB': '0xaF99374Dd015dA244cdA1F1Fc2183b423a17A10D',
    'TON': 'UQATaVtLxM93Sms6jNJwrMjQ_UOKTOvR2niXyS6ONIkx2HNc'
};

// نرخ ارزها (مقادیر نمونه)
const exchangeRates = {
    'TRX': 0.12,
    'USDT': 1,
    'BTC': 50000,
    'ETH': 3000,
    'BNB': 500,
    'TON': 2.5
};

// آیکون‌ها برای هر ارز
const currencyIcons = {
    'TRX': 'fab fa-tron',
    'USDT': 'fab fa-usd',
    'BTC': 'fab fa-bitcoin',
    'ETH': 'fab fa-ethereum',
    'BNB': 'fab fa-bnb',
    'TON': 'fas fa-coins'
};

// نام نمایشی ارزها
const currencyNames = {
    'TRX': 'TRON (TRX)',
    'USDT': 'Tether (USDT)',
    'BTC': 'Bitcoin (BTC)',
    'ETH': 'Ethereum (ETH)',
    'BNB': 'Binance Coin (BNB)',
    'TON': 'Toncoin (TON)'
};

document.addEventListener('DOMContentLoaded', function() {
    const totalAmount = {{ total_amount }};
    const currencyButtons = document.querySelectorAll('.currency-btn');
    
    currencyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currency = this.dataset.currency;
            const address = cryptoAddresses[currency];
            const rate = exchangeRates[currency];
            const amount = totalAmount / rate;
            
            // به روزرسانی نمایش مبلغ
            document.getElementById('payment-amount').textContent = 
                `${amount.toFixed(6)} ${currency}`;
            
            // به روزرسانی آدرس
            document.getElementById('crypto-address').value = address;
            
            // به روزرسانی QR code
            document.getElementById('qr-code').src = 
                `{% static 'Qrfolder/' %}${currency.toLowerCase()}.png;
            
            // نمایش جزئیات پرداخت
            document.getElementById('payment-details').classList.remove('d-none');
            
            // ذخیره اطلاعات پرداخت جاری
            window.currentPayment = {
                currency: currency,
                amount: amount,
                address: address
            };
        });
    });
});

function copyAddress() {
    const addressInput = document.getElementById('crypto-address');
    addressInput.select();
    document.execCommand('copy');
    alert('آدرس کپی شد!');
}

function confirmPayment() {
    const payment = window.currentPayment;
    if (!payment) {
        alert('لطفا یک روش پرداخت انتخاب کنید');
        return;
    }
    
    document.getElementById('modal-amount').textContent = 
        `${payment.amount.toFixed(6)} ${payment.currency}`;
    
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    paymentModal.show();
}

function finalizePayment() {
    // ارسال درخواست به سرور برای ثبت پرداخت
    fetch('{% url "process_payment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            currency: window.currentPayment.currency,
            amount: window.currentPayment.amount,
            address: window.currentPayment.address
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "order_success" %}';
        } else {
            alert('خطا در ثبت پرداخت: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در ارتباط با سرور');
    });
}
</script>
{% endblock %}