{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container my-5">

  <!-- پیام‌های سیستم -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2" role="alert">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- هدر و جستجو -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 fw-bold text-primary mb-1">💊 داروخانه آنلاین</h1>
      <div class="text-muted">جستجو، مشاهده و خرید دارو در گروه‌های متنوع</div>
    </div>
    <form method="get" class="d-flex" role="search">
      <input class="form-control me-2" type="search" name="q" value="{{ query }}" placeholder="نام، توضیح یا کُد دارو...">
      <button class="btn btn-primary" type="submit">جستجو</button>
    </form>
  </div>

  <!-- گروه‌ها -->
  <div class="accordion" id="medicineAccordion">
    {% for group in groups %}
      <div class="accordion-item mb-3 rounded-3 overflow-hidden shadow-sm">
        <h2 class="accordion-header" id="heading-{{ group.key }}">
          <button class="accordion-button collapsed fw-semibold" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-{{ group.key }}"
                  aria-expanded="false"
                  aria-controls="collapse-{{ group.key }}">
            {{ group.name }}
          </button>
        </h2>

        <div id="collapse-{{ group.key }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ group.key }}" data-bs-parent="#medicineAccordion">
          <div class="accordion-body bg-light">
            <div class="row g-3">
              {% for variant in group.variants %}
                <div class="col-xl-3 col-lg-4 col-md-6">
                  <div class="card h-100 border-0 shadow-sm rounded-3">
                    <a href="{% url 'medicine_detail' variant.id %}" class="position-relative">
                      {% if variant.image %}
                        <img src="{% static variant.image %}" class="card-img-top" alt="{{ variant.name }}" style="height:200px; object-fit:cover;">
                      {% else %}
                        <img src="{% static 'images/default.jpg' %}" class="card-img-top" alt="no image" style="height:200px; object-fit:cover;">
                      {% endif %}
                      <span class="badge bg-success position-absolute top-0 end-0 m-2 px-3 py-2">${{ variant.price }}</span>
                    </a>
                    <div class="card-body d-flex flex-column">
                      <h5 class="card-title fs-6 fw-bold mb-1">{{ variant.name }}</h5>
                      <p class="card-text text-muted small mb-2">{{ variant.description|default:"بدون توضیحات" }}</p>
                      {% if variant.exp %}
                        <div class="text-muted small mb-2">انقضا: {{ variant.exp }}</div>
                      {% endif %}
                      <div class="mt-auto">
                        <form method="post" action="{% url 'cart_add' variant.id %}">
                          {% csrf_token %}
                          <div class="input-group input-group-sm mb-2">
                            <input type="number" class="form-control text-center" name="qty" value="1" min="1">
                          </div>
                          <button type="submit" class="btn btn-primary w-100">🛒 افزودن به سبد</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="text-center text-muted py-4">آیتمی در این گروه موجود نیست.</div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="alert alert-warning text-center">هیچ گروهی جهت نمایش یافت نشد.</div>
    {% endfor %}
  </div>

  <!-- صفحه‌بندی -->
  {% if page_obj.paginator.num_pages > 1 %}
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?q={{ query }}&page={{ page_obj.previous_page_number }}">قبلی</a>
          </li>
        {% endif %}
        {% for i in page_obj.paginator.page_range %}
          <li class="page-item {% if page_obj.number == i %}active{% endif %}">
            <a class="page-link" href="?q={{ query }}&page={{ i }}">{{ i }}</a>
          </li>
        {% endfor %}
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?q={{ query }}&page={{ page_obj.next_page_number }}">بعدی</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>
{% endblock %}
